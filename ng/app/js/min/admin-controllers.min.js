"use strict";var getUsers=function(e,n,t,i){var o=e.all("users");o.getList().then(function(e){var o=e;t&&(o=[],e.forEach(function(e){0===e.role&&o.push(e)})),n.users=o,i&&i(o)})},checkAdmin=function(e,n,t){e.$parent.bodyClass="",e.isAdmin=!1,n.get("/checkAdmin").success(function(n){n&&n.length>0?e.isAdmin=!0:t.path("/")}).error(function(){t.path("/")})};angular.module("myApp.admin.controllers",["restangular"]).controller("AdminCtrl",["$scope","$location","Restangular","$http",function(e,n,t,i){checkAdmin(e,i,n),getUsers(t,e,!1),e.createUser=function(){n.path("/newuser")};var o=t.all("dwellings");o.getList().then(function(n){e.dwellings=n}),e.createUser=function(){n.path("/newuser")},e.createDwelling=function(){n.path("/newdwelling")}}]).controller("UserCtrl",["$scope","$location","Restangular","$routeParams","$http",function(e,n,t,i,o){checkAdmin(e,o,n);var r=i.userId?i.userId:0;e.roles=[{value:0,label:"Locataire"},{value:1,label:"Administrateur"},{value:2,label:"Visiteur"}];var s=t.one("users",r);s.get().then(function(t){t&&"null"!=t?e.user=t:n.path("/admin")}),e.cancel=function(){n.path("/admin")},e.save=function(){e.user.name&&0!=e.user.name.length&&e.user.login&&0!=e.user.login.length&&(0==r?e.user.post().then(function(t){t.id?n.path("/admin"):(e.user.name=t.name,e.user.login=t.login,e.user.role=t.role,e.user.lastError=t.lastError)}):e.user.put().then(function(){n.path("/admin")}))},e.del=function(){confirm("Supprimer cet utilisateur ?")&&e.user.remove().then(function(e){e?alert(e.lastError):n.path("/admin")})},e.sendNewUser=function(){o.post("/sendNewUser/"+r).success(function(){alert("Le mail a été envoyé")}).error(function(){alert("Erreur, le mail n'a pas été envoyé")})},o.get("/userEvents/"+r).success(function(n){e.events=n}),e.getEventTypeAsString=function(e){return 1==e.eventType?"connexion":2==e.eventType?"déconnexion":"?"},o.get("/userVisits/"+r).success(function(n){e.visitCount=n[0],e.visits=n[1]}),e.getOriginText=getOriginPointsEvent,o.get("/userPoints/"+r).success(function(n){e.points=n[0],e.pointsEvents=n[1]}),e.getDeviceInfo=function(e){var n=new UAParser(e),t=n.getResult();return t.browser.name+" "+t.browser.version+", "+(void 0==t.device.model?"":t.device.model+", ")+t.os.name+" "+t.os.version}}]).controller("DwellingCtrl",["$scope","$location","Restangular","$routeParams","$http",function(e,n,t,i,o){checkAdmin(e,o,n);var r=i.dwellingId?i.dwellingId:0,s=t.one("dwellings",r);s.get().then(function(i){getUsers(t,e,!0,function(e){if(i&&i.user)for(var n=0;n<e.length;n++)if(i.user.id==e[n].id){i.user=e[n];break}}),i&&"null"!=i?e.dwelling=i:n.path("/admin")}),e.cancel=function(){n.path("/admin")},e.save=function(){e.dwelling.label&&0!=e.dwelling.label.length&&(0==r?e.dwelling.post().then(function(){n.path("/admin")}):e.dwelling.put().then(function(){n.path("/admin")}))},e.del=function(){confirm("Supprimer ce logement ?")&&e.dwelling.remove().then(function(){n.path("/admin")})}}]).controller("ConfigCtrl",["$scope","FileUploader","$location","$http",function(e,n,t,i){checkAdmin(e,i,t),i.get("/upload/consFiles").success(function(n){e.consFiles=n});var o=e.uploader=new n({scope:e,url:"/uploadSavings",autoUpload:!0,formData:[{key:"value"}],onSuccessItem:function(n,t){e.consFile=t[0],e.consFiles.unshift(e.consFile),e.rawSavings=t[1],e.consImported=!1},onBeforeUploadItem:function(){e.processing=!0},onErrorItem:function(){alert("Erreur, vérifiez le format du fichier")},onCompleteItem:function(){e.processing=!1}});e.importCons=function(){e.processing=!0,i.post("/importSavings/"+e.consFile.id).success(function(){e.consImported=!0,e.consFile.imported=!0,e.processing=!1}).error(function(){e.processing=!1,alert("Erreur lors du traitement du fichier")})},e.notifyUsers=function(){confirm("Confirmez-vous l'envoi des courriels et SMS ?")&&i.post("/upload/notifyUsers",{year:e.consFile.year,week:e.consFile.week}).success(function(){e.consImported=!1,e.consFile=void 0,o.clearQueue()}).error(function(){alert("Erreur lors de la notification des utilisateurs")})},i.get("/upload/tipsFiles").success(function(n){e.tipsFiles=n});var r=e.tipsUploader=new n({scope:e,url:"/uploadTips",autoUpload:!0,formData:[{key:"value"}],onSuccessItem:function(n,t){e.tipsFile=t[0],e.tipsFiles.unshift(e.tipsFile),e.tips=t[1],e.tipsImported=!1},onBeforeUploadItem:function(){e.processing=!0},onErrorItem:function(){alert("Erreur, vérifiez le format du fichier")},onCompleteItem:function(){e.processing=!1}});e.importTips=function(){e.processing=!0,i.post("/importTips/"+e.tipsFile.id).success(function(){e.tipsFile.imported=!0,e.processing=!1,e.tipsFile=void 0,r.clearQueue()}).error(function(){e.processing=!1,alert("Erreur lors du traitement du fichier")})}}]).controller("ChartsCtrl",["$scope","$http","$location","$timeout",function(e,n,t){checkAdmin(e,n,t);var i=function(n){for(var t=[],i=e.firstWeek+1;i<=e.lastWeek;i++){var o=Tree.getSavingOfWeek(i,e.firstWeek,n.savings);t.push({week:o.week,global:100*o.global,heatingCons:o.heatingCons,electricityCons:o.electricityCons/10,waterCons:o.waterCons/500,hotWaterCons:5*o.hotWaterCons,fruits:o.elts.length})}return t};e.loadingData=!0,n.get("/uiDwellings/0?details=true").success(function(n){e.dwellings=n,e.firstWeek=n[0].savings[n[0].savings.length-1].week,e.lastWeek=n[0].savings[0].week,n.forEach(function(e){e.chartData=i(e)}),e.loadingData=!1}).error(function(){e.loadingData=!1,debug("Error when loading dwellings")})}]);