"use strict";var debug=function(e){var t=new Date;console.log(t.getMinutes()+":"+t.getSeconds()+":"+t.getMilliseconds()+" - "+e)},CUSTOM_THRESHOLDS=[15,150,300];"function"!=typeof String.prototype.endsWith&&(String.prototype.endsWith=function(e){return-1!==this.indexOf(e,this.length-e.length)});var onError=function(e,t){(e=500)&&(t.path("/"),window.location="/logout")},getUiUser=function(e,t,n,r){e.$parent.bodyClass="game",t.get("/uiUser").success(function(t){e.user=t,e.user.isTenant=0===t.role,e.points=t.points,e.$parent.pageLoaded=!0,r&&r()}).error(function(e,t){onError(t,n)})},getOriginPointsEvent=function(e){var t={};t.DECOR="Décor",t.GIFT="Cadeau",t.WIN_GAME="Jeko-Quizz";var n=t[e];return n||(n="?"),n},managePoints=function(e,t,n){t.get("/uiPointsEvents").success(function(t){e.pointsEvents=t}).error(function(e,t){onError(t,n)}),e.getOriginText=getOriginPointsEvent},MN_HOURS_COEFF=2387,getMagicNumber=function(){var e=new Date;return 17589*e.getDay()+e.getHours()*MN_HOURS_COEFF},isValidMagicNumber=function(e){var t=getMagicNumber();return MN_HOURS_COEFF>=t-e},carrouselDecor=function(e,t){t.get("/Application/shop").success(function(t){e.decorsThumbnails=Games.shuffle(t)}).error(function(e,t){onError(t,$location)})};angular.module("myApp.controllers",["uiSlider"]).controller("IndexCtrl",["$scope","$http","$location","$window","$route",function(e,t,n,r,a){e.bodyClass="",t.post("/Use/visit?sw="+window.screen.availWidth+"&sh="+window.screen.availHeight+"&ww="+window.innerWidth+"&wh="+window.innerHeight).success(function(t){var r=t[0];e.userName=r.name,e.avatar=r.avatarName?"avatars/"+r.avatarName:"icon-account.png",r.accepted||n.path("/account"),TimeMachine.firstYear=t[1],TimeMachine.firstWeek=t[2],TimeMachine.lastWeekOfYear=t[3]}).error(function(e,t){onError(t,n)}),e.exit=function(){n.path("/byebye")},angular.element(r).bind("orientationchange",function(){a.reload()})}]).controller("InfosCtrl",["$scope","$http","$location",function(e){e.$parent.withoutFooter=!0}]).controller("ByeByeCtrl",["$scope",function(){}]).controller("AccountCtrl",["$scope","$http","$location",function(e,t,n){e.$parent.withoutFooter=!1,e.magicNumber=getMagicNumber();var r,a=function(t){e.user=t,e.user.isTenant=0===t.role,e.user.roleLabel=["Locataire","Administrateur","Visiteur"][t.role],r=angular.copy(t),e.userModified=!t.accepted};t.get("/uiUser").success(function(t){a(t),e.$parent.pageLoaded=!0}).error(function(e,t){onError(t,n)}),e.cancel=function(){e.user=angular.copy(r),e.userModified=!1},e.save=function(){t.post("/Application/saveUser",e.user).success(function(t){e.user.accepted?(a(t),alert("Modifications enregistrées")):n.path("/all"),e.userModified=!0}).error(function(){alert("Erreur lors de l'enregistrement")})},e.editingPassword=!1,e.editPassword=function(){e.editingPassword=!0},e.savePassword=function(){e.pwd1&&e.pwd1.length>0&&e.pwd1===e.pwd2?t.post("/pwd?pwd="+e.pwd1).success(function(){alert("Votre nouveau mot de passe a bien été enregistré"),e.editingPassword=!1}).error(function(){alert("Erreur, votre mot de passe n'a pas été enregistré")}):alert("Mot de passe incorrect")},e.cancelPassword=function(){e.editingPassword=!1},e.modified=function(){e.userModified=!0}}]).controller("CustomCtrl",["$scope","$http","$location",function(e,t,n){e.magicNumber=getMagicNumber(),e.withoutPoints=!0;var r;e.custom={};var a=function(){if(e.user&&Tree.symbolsLoaded){e.customLevel=-1;for(var t=CUSTOM_THRESHOLDS.length-1;t>=0;t--)if(e.user.meVisits>=CUSTOM_THRESHOLDS[t]){e.customLevel=t;break}for(var n=function(e,t){return 0==t||4>t&&e>=0||7>t&&e>=1||2==e},r=[],a=0;a<Tree.TREE_SYMBOLS.length;a++){var i="not-allowed.svg";n(e.customLevel,a)&&(i=Tree.TREE_SYMBOLS[a]),r.push({img:i,id:a})}e.treeSymbols=r,o(e.user.avatarName)}},o=function(t){if(e.custom.avatar=t,e.$parent.dwelling)if(e.$parent.dwelling.avatar=t,r=new Tree(e.$parent.dwelling,!1),r.clear(),e.custom.avatar==e.user.avatarName)r.initWithAllFruits(),r.draw(),r.drawFruits();else{var n=0;e.$parent.dwelling.savings.forEach(function(e){n+=e.elts.length}),r.draw(),r.drawRandomFruits("big-fruit.svg",Math.floor(n/10)),r.drawRandomFruits("fruit.svg",n%10)}else r=new Tree({avatar:t},!1),r.clear(),r.draw()};getUiUser(e,t,n,a),Tree.setup(a),e.selectTree=function(t){"not-allowed.svg"!=t&&(e.modified=t!=e.user.avatarName,o(t))},e.cancel=function(){e.modified=!1,o(e.user.avatarName)},e.save=function(){e.user.avatarName!=e.custom.avatar&&t.post("/Application/customize",e.custom).success(function(){e.modified=!1,n.path("/me/"+e.user.dwellingId+"/"+getMagicNumber())}).error(function(){alert("Erreur lors de l'enregistrement")})}}]).controller("ShopCtrl",["$scope","$http","$location",function(e,t,n){e.magicNumber=getMagicNumber(),getUiUser(e,t,n),managePoints(e,t,n),e.cart={},e.cart.elements=[],e.loadingData=!0,t.get("/Application/shop").success(function(t){e.elements=t,e.loadingData=!1}).error(function(t,r){e.loadingData=!1,onError(r,n)});var r=function(){e.cart.total=e.cart.elements.reduce(function(e,t){return e+t.price},0),e.canBuy=e.cart.elements.length>0&&e.cart.total<=e.points};e.addElement=function(t){t.selected=!t.selected,t.selected?e.cart.elements.push(t):e.removeElement(t),r()};var a=function(t){for(var n=0;n<e.cart.elements.length;n++)if(e.cart.elements[n].id==t.id){e.cart.elements.splice(n,1);break}};e.removeElement=function(e){e.selected=!1,a(e),r()},e.cancel=function(){e.cart={},e.cart.elements=[],e.canBuy=!1,e.elements.forEach(function(e){e.selected=!1})},e.buy=function(){t.post("/Application/buy",e.cart.elements).success(function(){n.path("/all/")}).error(function(){alert("Erreur lors de l'ajout de décors")})}}]).controller("GamesCtrl",["$scope","$http","$location","$routeParams","$document","$timeout",function(e,t,n,r,a,o){getUiUser(e,t,n),e.$parent.bodyClass="",e.$parent.withoutFooter=!0,e.firstTime=!0,e.goodAnswers=0,e.gameIndex=0;var i=function(){e.goodAnswers+=e.game.win?1:0,(3==e.goodAnswers||e.gameIndex==e.games.length-1)&&(e.ended=!0,e.started=!1),o(function(){var e=angular.element(document.getElementById("bottomAnchor"));a.scrollToElement(e,0,1e3)})},s=function(){for(var t=[],n=0;10>n;n++)t.push(new MyConsQuizz(e,i));for(var n=0;5>n;n++)t.push(new JekoQuizz(e,i));if(!matchMediaPhone())for(var n=0;3>n;n++)t.push(new MyChart(e,i));return Games.shuffle(t),t};e.getTemplate=function(){return"templates/game-"+e.game.id+".html"},e.cancelGame=function(){e.nextGame()},e.cancelAll=function(){e.ended=!0,e.started=!1},e.nextGame=function(){e.gameIndex++,e.gameIndex<e.games.length?(e.game=e.games[e.gameIndex],e.game.start()):(e.ended=!0,e.started=!1)},e.goToMe=function(){MyConsQuizz.validated=!0,n.path("/me/"+e.user.dwellingId+"/"+getMagicNumber())},e.loadingData=!0,t.get("/Application/gameTypes").success(function(t){Games.JekoQuizz.init(t[0]),Games.MyConsQuizz.init(t[1]),Games.MyChart.init(t[2]),e.startGame=function(){Games.JekoQuizz.reset(),Games.MyConsQuizz.reset(),Games.MyChart.reset(),e.games=s(),e.firstTime=!1,e.started=!0,e.ended=!1,e.goodAnswers=0,e.gameIndex=0,e.game=e.games[e.gameIndex],e.game.start()},e.loadingData=!1}).error(function(t,r){e.loadingData=!1,onError(r,n)})}]).controller("QuizzCtrl",["$scope","$http","$location","$routeParams","$document","$timeout","$interval",function(e,t,n,r,a,o,i){e.magicNumber=getMagicNumber(),getUiUser(e,t,n),managePoints(e,t,n),e.$parent.withoutFooter=!0,e.gameCount=0,e.goodAnswers=0,e.gameIndex=0;var s=function(){var t=e.game.win?1:0;e.goodAnswers+=t,e.points+=t,o(function(){var e=angular.element(document.getElementById("bottomAnchor"));a.scrollToElement(e,0,1e3)})},c=function(){for(var t=[],n=0;6>n;n++)t.push(new JekoQuizz(e,s));return Games.shuffle(t),t};e.getTemplate=function(){return"templates/game-"+e.game.id+".html"},e.cancelGame=function(){e.nextGame()},e.cancelAll=function(){e.gameIndex=e.games.length-1,e.nextGame()},e.nextGame=function(){e.gameIndex++,e.gameIndex==e.games.length?(e.ended=!0,e.started=!1,e.goodAnswers>0&&t.post("/Use/winGame?points="+e.goodAnswers).success(function(t){e.points=t[0],e.pointsEvents=t[1],e.highestScore=t[2]})):(e.game=e.games[e.gameIndex],e.game.start())},e.loadingData=!0,t.get("/Application/gameTypes").success(function(t){Games.JekoQuizz.init(t[0]),e.startGame=function(){Games.JekoQuizz.reset(),e.games=c(),e.gameCount++,e.started=!0,e.ended=!1,e.goodAnswers=0,e.gameIndex=0,e.game=e.games[e.gameIndex],e.game.start()},e.loadingData=!1}).error(function(t,r){e.loadingData=!1,onError(r,n)}),carrouselDecor(e,t,i)}]);