"use strict";angular.module("myApp.Me-controller",["uiSlider"]).controller("MeCtrl",["$scope","$routeParams","$location","$http","$interval","$timeout","$localStorage","$modal",function(e,t,a,n,r,i,o,l){e.$parent.bodyClass="",e.$parent.withoutFooter=!1,e.helpFirstIndex=1,e.chartsOpened=!0,e.loadingShapes=!0,Tree.setup(function(){i(function(){e.loadingShapes=!1,d()})});var u;e.week=1,e.firstWeek=1,e.lastWeek=2;var c=function(){for(var t=0,a=0,n=0,r=0,i=0,o=[],l=[],c=[],s=[],h=[],d=e.firstWeek;d<=e.week;d++){var g=u.getSaving(d),w=TimeMachine.getDateOfWeekIndex(d).addDays(6),p=Math.round(g.heatingCons*e.dwelling.surface);o.push({week:g.week,date:w,value:p}),t+=p;var k=Math.round(g.electricityCons);l.push({week:g.week,date:w,value:k}),a+=k;var m=Math.round(.045*g.waterCons);c.push({week:g.week,date:w,value:m}),s.push({week:g.week,date:w,value:Math.round(g.waterCons)}),n+=g.waterCons;var v=Math.round(g.hotWaterCons*e.dwelling.surface);h.push({week:g.week,date:w,value:v}),r+=v;var f=Math.max(p,k,m,v);f>i&&(i=f)}for(var d=1*e.week+1;d<=e.lastWeek;d++)o.push({week:d,value:"no value"}),l.push({week:d,value:"no value"}),c.push({week:d,value:"no value"}),h.push({week:d,value:"no value"});e.dwelling.chartHeating=o,e.dwelling.chartElectricity=l,e.dwelling.chartWater=c,e.dwelling.chartWaterLiters=s,e.dwelling.chartHotWater=h,e.heatingSum=Math.round(t),e.electricitySum=Math.round(a),e.waterSum=Math.round(n),e.hotWaterSum=Math.round(r),e.axisMax=i},s=function(){u&&(e.currentSaving=u.getSaving(e.week),u.update(e.week),e.thisWeekNbFruits=0,e.currentSaving&&e.currentSaving.elts&&(e.thisWeekNbFruits+=e.currentSaving.elts.length),e.totalFruits=u.nbFruits,u.drawFruits(),c())},h=new TimeMachine(e,r,s,function(){return u.dwelling.savings.length}),d=function(){e.loadingData||e.loadingShapes||(u.draw(),s(),h.animate(e,r))},g=t.magicNumber;isValidMagicNumber(g)||a.path("/games");var w=t.dwellingId?t.dwellingId:0;e.loadingData=!0,n.get("/uiDwelling/"+w).success(function(t){t.id!=w&&a.path("/me/"+t.id+"/"+g),e.dwelling=t,e.parent&&(e.$parent.dwelling=t),e.points=t.points,u=new Tree(t,!1),e.lastWeek=t.savings[0].week,e.firstWeek=t.savings[t.savings.length-1].week,Tree.firstWeek=e.firstWeek,e.week=TimeMachine.doAnimation()?e.lastWeek-1:e.lastWeek,e.loadingData=!1,e.$parent.pageLoaded=!0,d()}).error(function(t,n){e.loadingData=!1,debug("Error when loading dwelling"),onError(n,a)}),managePoints(e,n,a),e.introOptions=Help.meIntroOptions(),matchMediaPhone()||i(function(){Help.startFirstTime("me",e,o)},1e3),carrouselDecor(e,n,r);var p=!1,k=function(e,t){e.close=function(){t.close()}},m=function(){l.open({templateUrl:"templates/chartModalContent.html",controller:k,scope:e,size:"lg",backdrop:"static"})},v=function(){var e=-1;p?m():n.post("/Use/charts").success(function(t){p=!0;for(var n=0;n<CUSTOM_THRESHOLDS.length;n++)if(CUSTOM_THRESHOLDS[n]==t){e=n;break}e>=0?a.path("/custom"):m()}).error(function(){m()})};e.showHeatingChart=function(){e.chartEnergy="Gaz - chauffage",e.chartSum=e.heatingSum,e.unit="kWh",e.chartData=e.dwelling.chartHeating,v()},e.showElectricityChart=function(){e.chartEnergy="Electricit√©",e.chartSum=e.electricitySum,e.unit="kWh",e.chartData=e.dwelling.chartElectricity,v()},e.showWaterChart=function(){e.chartEnergy="Eau";var t=""+Math.round(e.waterSum/100)/10;e.chartSum=t.replace(".",","),e.unit="m3",e.chartData=e.dwelling.chartWaterLiters,v()},e.showHotWaterChart=function(){e.chartEnergy="Gaz - eau chaude",e.chartSum=e.hotWaterSum,e.unit="kWh",e.chartData=e.dwelling.chartHotWater,v()}}]);