"use strict";function Tree(e,t){this.dwelling=e,this.inOrchard=t,this.treeSymbol=Tree.symbols[e.avatar]}Tree.symbols={},Tree.symbolsLoaded=!1,Tree.TREE_SYMBOLS=["default-tree.svg","peuplier.svg","sapin.svg","cypres.svg","chene.svg","olivier.svg","acacia.svg","pin-maritime.svg","pin-parasol.svg","pin-parasol-2.svg","cocotier.svg"],Tree.FRUIT_SYMBOLS=["fruit.svg","big-fruit.svg"],Tree.randomInt=function(e,t){return Math.round(Math.random()*(t-e)+e)},Tree.setup=function(e){paper.setup("treeCanvas"),Tree.preload(e)},Tree.preload=function(e){if(Object.keys(Tree.symbols).length>0)return e&&e(),void 0;var t=Tree.FRUIT_SYMBOLS.concat(Tree.TREE_SYMBOLS);t.push("crown.svg"),t.forEach(function(r){paper.project.importSVG("img/avatars/"+r,function(i){Tree.symbols[r]=new paper.Symbol(i),e&&Object.keys(Tree.symbols).length==t.length&&(Tree.symbolsLoaded=!0,e&&e())})})},Tree.compareBottom=function(e,t){return e.getBottom()<t.getBottom()?-1:e.getBottom()>t.getBottom()?1:0},Tree.prototype.setPosition=function(e,t,r){this.x=e,this.y=t,this.mine=r},Tree.prototype.getBottom=function(){return this.y+this.treeSymbol.definition.bounds.height/2},Tree.prototype.clear=function(){paper.project.activeLayer.removeChildren()},Tree.prototype.draw=function(){var e=this;if(e.inOrchard||(e.x=paper.view.center.x,e.y=paper.view.center.y),e.mine&&(e.treeSymbol=e.treeSymbol.clone()),e.treeSymbol){var t=new paper.Point(e.x,e.y);if(e.treeItem=e.treeSymbol.place(t),e.inOrchard){var r=new paper.Point(e.x-e.treeSymbol.definition.bounds.width/2,e.y-e.treeSymbol.definition.bounds.height/2),i=new paper.Path.Rectangle(r,e.treeSymbol.definition.bounds.size);i.fillColor=new paper.Color(0,0,0,0),i.onMouseEnter=function(){matchMediaPhone()||(e.showTooltip&&e.showTooltip(),e.mine&&(document.body.style.cursor="pointer"))},i.onMouseLeave=function(){matchMediaPhone()||(e.hideTooltip&&e.hideTooltip(),e.mine&&(document.body.style.cursor="default"))},e.mine&&(e.getTreeShape(),e.treeItem.symbol.definition.shadowColor="#FFFFFF",e.treeItem.symbol.definition.shadowBlur=35,e.treeItem.clone(),e.treeItem.clone(),e.treeItem.clone(),e.treeItem.clone(),e.treeItem.clone(),i.onClick=function(){document.body.style.cursor="default",e.onClick()},e.treeItem.onFrame=function(t){var r=Math.abs(Math.sin(t.time));e.treeItem.symbol.definition.shadowBlur=15*r}),this.dwelling.hasHighestScore&&this.drawHighestScore()}else{var o=angular.element("#treeCanvas"),n=o.width(),s=o.height(),a=n/(e.treeSymbol.definition.bounds.width+20),p=s/(e.treeSymbol.definition.bounds.height+20),h=Math.min(a,p);paper.view.zoom=h,Tree.adjust=new paper.Point(paper.project.activeLayer.position.x-paper.view.center.x,paper.project.activeLayer.position.y-paper.view.center.y),paper.project.activeLayer.position=paper.view.center,paper.view.draw()}}this.drawn=!0},Tree.prototype.getSaving=function(e){return Tree.getSavingOfWeek(e,Tree.firstWeek,this.dwelling.savings)},Tree.getSavingOfWeek=function(e,t,r){return r[r.length-(e-t)-1]},Tree.prototype.createFruits=function(e){var t=this;this.nbFruits=e.length,this.treeFruits=[];for(var r=0,i=9;i<e.length;i+=10)t.treeFruits.push({x:e[i].x,y:e[i].y,shape:"big-fruit.svg"}),r++;for(var i=10*r;i<e.length;i++)t.treeFruits.push({x:e[i].x,y:e[i].y,shape:"fruit.svg"})},Tree.prototype.update=function(e){for(var t=[],r=Tree.firstWeek;e>=r;r++){var i=this.getSaving(r);i.global>=0&&i.elts.forEach(function(e){t.push(e)})}this.createFruits(t)},Tree.prototype.initWithAllFruits=function(){var e=[];if(this.dwelling.savings)for(var t=this.dwelling.savings.length-1;t--;t>0){var r=this.dwelling.savings[t];r.global>=0&&r.elts.forEach(function(t){e.push(t)})}this.createFruits(e)},Tree.prototype.getTreeShape=function(){return this.treeItem.symbol.definition.getItem({name:"TreeShape"})},Tree.prototype.drawFruits=function(){if(this.drawn){var e=this;e.placedFruits?e.placedFruits.forEach(function(e){e.remove()}):e.placedFruits=[],e.treeFruits&&e.treeFruits.forEach(function(t){var r=e.drawFruit(t);r&&e.placedFruits.push(r)}),paper.view.draw()}},Tree.prototype.drawFruit=function(e){var t=this,r=Tree.symbols[e.shape];if(r){var i=t.x-t.treeSymbol.definition.bounds.width/2+e.x+r.definition.bounds.width/2,o=t.y-t.treeSymbol.definition.bounds.height/2+e.y+r.definition.bounds.height/2;t.inOrchard?(i-=Orchard.adjust.x,o=o-Orchard.adjust.y+Orchard.Y_OFFSET):(i-=Tree.adjust.x,o-=Tree.adjust.y);var n=new paper.Point(i,o),s=r.place(n);return"big-fruit.svg"==e.shape&&s.scale(1.2),s}console.log("error, no Symbol for "+e.shape)},Tree.prototype.drawRandomFruits=function(e,t){for(var r=this.getTreeShape(),i=[],o=0;t>o;o++){for(var n={x:0,y:0,shape:e},s=Tree.symbols[n.shape],a=0;1e3>a;a++){var p=new paper.Point(0,0);if(p.x=Tree.randomInt(0,r.bounds.width-s.definition.bounds.width/2),p.y=Tree.randomInt(0,r.bounds.height-s.definition.bounds.height/2),r.contains(p)){n.x=p.x-s.definition.bounds.width/2,n.y=p.y-s.definition.bounds.height/2;break}}var h=this.drawFruit(n);i.push(h)}return paper.view.draw(),i},Tree.prototype.drawHighestScore=function(){var e=Tree.symbols["crown.svg"],t=this.x,r=this.y-this.treeSymbol.definition.bounds.height/2-e.definition.bounds.height/2,i=new paper.Point(t,r);e.place(i)};