"use strict";angular.module("myApp.All-controller",["uiSlider"]).controller("AllCtrl",["$scope","$routeParams","$location","$http","$interval","$timeout","$localStorage","$window","$modal",function(e,n,t,a,r,i,o,s,l){e.$parent.withoutFooter=!1,e.$parent.bodyClass="",e.helpFirstIndex=2,e.bgList="url(img/backgrounds/bg-meadow.svg),url(img/backgrounds/bg-hill2.svg),url(img/backgrounds/bg-hill1.svg),url(img/backgrounds/bg-sky.svg)",e.weatherPopoverTrigger=matchMediaPhone()?"click":"mouseenter",e.loadingShapes=!0,Orchard.setup(function(){i(function(){e.loadingShapes=!1,v()})});var g,c;e.week=1,e.firstWeek=1,e.lastWeek=2;var u=function(e){return 100*e/c.trees.length},d=function(){if(g){e.thisWeekNbFruits=0;var n=0,t=0,a=0,r=0,i=0;if(c.trees.forEach(function(o){o.update(e.week);var s=o.getSaving(e.week);s.global>0&&n++,s.heating>0&&t++,s.electricity>0&&a++,s.water>0&&r++,s.hotWater>0&&i++,s&&s.elts&&(e.thisWeekNbFruits+=s.elts.length)}),e.savingsNbPercent=0,e.savingsNbEnergy="",u(n)>=50)e.savingsNbPercent=u(n);else{var o=Math.max(t,a,r,i);e.savingsNbPercent=u(o),o==t?e.savingsNbEnergy="de chauffage":o==a?e.savingsNbEnergy="d'électricité":o==r?e.savingsNbEnergy="d'eau":o==i&&(e.savingsNbEnergy="d'eau chaude sanitaire")}c.drawFruits()}},h=new TimeMachine(e,r,d,function(){return c.trees[0].dwelling.savings.length});e.mouseMove=function(n){if(!matchMediaPhone()){var t=n.pageX-20,a=n.pageY-40;e.tooltip&&c&&(200>a&&(e.tooltip=!1),angular.element("#tooltip").css("left",t),angular.element("#tooltip").css("top",a))}};var f=function(){return MyConsQuizz.validated};e.showMine=function(e){e.mine&&(f()?t.path("/me/"+e.dwellingId+"/"+getMagicNumber()):t.path("/games"))};var p=function(n){var a=[],r=0;n.forEach(function(n){var o=new Tree(n,!0);o.showTooltip=function(){i(function(){e.tooltip={fruits:o.nbFruits,mine:o.mine,dwellingId:o.dwelling.id,hasHighestScore:o.dwelling.hasHighestScore}},100)},o.hideTooltip=function(){i(function(){e.tooltip=!1})};var s,l=n.id==m&&n.canSee;l?s=Orchard.treesCenter:(s=r==Orchard.POSITIONS.length?Orchard.treesCenter:Orchard.treesPositions[r],r++),o.setPosition(s.x,s.y,l),o.onClick=function(){i(function(){f()?t.path("/me/"+o.dwelling.id+"/"+getMagicNumber()):t.path("/games")})},a.push(o)}),c=new Orchard(a)},v=function(){e.loadingData||e.loadingShapes||(c.draw(),d(),h.animate(e,r),a.get("/Application/decor").success(function(n){var t=[],a="";n.forEach(function(e){e.background?a+="url(img/backgrounds/bg-"+e.image+"),":t.push(e)}),a=a.substring(0,a.length-1),a.length>0&&(e.bgList=a),c.drawDecor(t)}))},m=n.dwellingId?n.dwellingId:0;e.loadingData=!0,a.get("/uiDwellings/"+m).success(function(n){m||(m=n[0].id);var t=n[0];e.lastWeek=t.savings[0].week,e.firstWeek=t.savings[t.savings.length-1].week,Tree.firstWeek=e.firstWeek,e.week=TimeMachine.doAnimation()?e.lastWeek-1:e.lastWeek,g=n,p(g),e.gaugeValue=b(n),e.loadingData=!1,e.$parent.pageLoaded=!0,v()}).error(function(n,a){e.loadingData=!1,debug("Error when loading dwellings"),onError(a,t)}),e.introOptions=Help.allIntroOptions(),matchMediaPhone()||i(function(){Help.startFirstTime("all",e,o)},1e3);var w=function(e){for(var n=[],t=0;t<e[0].savings.length;t++)n[t]=0;var a=0;e.forEach(function(e){a+=e.surface;var t=e.savings.slice();t.reverse(),t.forEach(function(t,a){var r=t.heatingCons>0?t.heatingCons*e.surface:0,i=.045*t.waterCons,o=t.hotWaterCons*e.surface;n[a]+=r+t.electricityCons+i+o})});for(var t=1;t<n.length;t++)n[t]+=n[t-1];for(var t=0;t<n.length;t++)n[t]=n[t]/a;return n},b=function(e){var n=w(e),t=151,a=100*n[n.length-1]/t;return a},k=function(e,n){e.close=function(){n.close()}};e.openGauge=function(){l.open({templateUrl:"templates/gaugeModalContent.html",controller:k,scope:e,size:"lg",backdrop:"static"})};var y={};y["clear-day"]="Beau temps",y["clear-night"]="Beau temps",y.rain="Pluie",y.snow="Neige",y.sleet="Neige fondue",y.wind="Vent",y.fog="Brouillard",y.cloudy="Nuageux",y["partly-cloudy-day"]="Partiellement nuageux",y["partly-cloudy-night"]="Partiellement nuageux";var N=function(){a.get("/weather").success(function(n){e.weather=n,n.current&&(e.weather.title=y[n.current])}).error(function(e,n){onError(n,t)})};N(),r(N,6e5)}]);